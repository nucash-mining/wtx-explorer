<!DOCTYPE html>
<html>
<head>
  <title>WATTx Explorer</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f8f9fa; }

    /* Header */
    .header { background: linear-gradient(135deg, #1e3a5f 0%, #2563eb 100%); color: white; padding: 15px 0; }
    .header-inner { max-width: 1400px; margin: 0 auto; padding: 0 20px; display: flex; justify-content: space-between; align-items: center; }
    .logo { font-size: 24px; font-weight: bold; text-decoration: none; color: white; }
    .nav { display: flex; gap: 25px; }
    .nav a { color: rgba(255,255,255,0.9); text-decoration: none; font-size: 14px; }
    .nav a:hover { color: white; }
    .search-box { display: flex; }
    .search-box input { padding: 10px 15px; border: none; border-radius: 6px 0 0 6px; width: 350px; font-size: 14px; }
    .search-box button { padding: 10px 20px; background: #1d4ed8; color: white; border: none; border-radius: 0 6px 6px 0; cursor: pointer; }

    /* Main container */
    .container { max-width: 1400px; margin: 0 auto; padding: 20px; }

    /* Cards */
    .card { background: white; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 20px; overflow: hidden; }
    .card-header { padding: 15px 20px; border-bottom: 1px solid #e5e7eb; font-weight: 600; font-size: 16px; display: flex; justify-content: space-between; align-items: center; }
    .card-body { padding: 20px; }

    /* Stats grid */
    .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 20px; }
    .stat-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .stat-label { color: #6b7280; font-size: 13px; margin-bottom: 5px; }
    .stat-value { font-size: 24px; font-weight: 600; color: #1f2937; }
    .stat-value.green { color: #059669; }
    .stat-value.blue { color: #2563eb; }

    /* Tables */
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #e5e7eb; font-size: 14px; }
    th { background: #f9fafb; font-weight: 600; color: #374151; }
    tr:hover { background: #f9fafb; }

    /* Badges */
    .badge { display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 500; }
    .badge-pos { background: #d1fae5; color: #065f46; }
    .badge-pow { background: #dbeafe; color: #1e40af; }
    .badge-success { background: #d1fae5; color: #065f46; }
    .badge-pending { background: #fef3c7; color: #92400e; }
    .badge-token { background: #ede9fe; color: #5b21b6; }

    /* Links & addresses */
    .hash { font-family: 'SF Mono', Monaco, monospace; font-size: 13px; color: #2563eb; text-decoration: none; }
    .hash:hover { text-decoration: underline; }
    .address { font-family: 'SF Mono', Monaco, monospace; font-size: 13px; }
    .addr-link { color: #2563eb; text-decoration: none; }
    .addr-link:hover { text-decoration: underline; }

    /* Tabs */
    .tabs { display: flex; border-bottom: 1px solid #e5e7eb; margin-bottom: 20px; }
    .tab { padding: 12px 20px; cursor: pointer; border-bottom: 2px solid transparent; font-weight: 500; color: #6b7280; }
    .tab:hover { color: #1f2937; }
    .tab.active { border-bottom-color: #2563eb; color: #2563eb; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* Forms */
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; font-weight: 500; color: #374151; }
    .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; }
    .form-group textarea { font-family: monospace; min-height: 150px; }
    .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 14px; }
    .btn-primary { background: #2563eb; color: white; }
    .btn-primary:hover { background: #1d4ed8; }
    .btn-secondary { background: #e5e7eb; color: #374151; }

    /* Contract interaction */
    .function-card { border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 10px; }
    .function-header { padding: 12px 15px; background: #f9fafb; cursor: pointer; display: flex; justify-content: space-between; }
    .function-body { padding: 15px; display: none; }
    .function-body.open { display: block; }
    .read-fn { border-left: 3px solid #059669; }
    .write-fn { border-left: 3px solid #dc2626; }

    /* Code display */
    .code-block { background: #1e1e1e; color: #d4d4d4; padding: 15px; border-radius: 6px; font-family: monospace; font-size: 13px; overflow-x: auto; white-space: pre-wrap; word-break: break-all; }

    /* Page layouts */
    .page { display: none; }
    .page.active { display: block; }
    .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }

    /* Detail rows */
    .detail-row { display: flex; padding: 12px 0; border-bottom: 1px solid #e5e7eb; }
    .detail-label { width: 200px; color: #6b7280; font-size: 14px; }
    .detail-value { flex: 1; font-size: 14px; word-break: break-all; }

    /* Copy button */
    .copy-btn { background: none; border: 1px solid #d1d5db; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px; margin-left: 8px; }
    .copy-btn:hover { background: #f3f4f6; }

    /* Loading */
    .loading { text-align: center; padding: 40px; color: #6b7280; }
  </style>
</head>
<body>

<div class="header">
  <div class="header-inner">
    <a href="#" class="logo" onclick="showPage('home')">WATTx Explorer</a>
    <nav class="nav">
      <a href="#" onclick="showPage('home')">Home</a>
      <a href="#" onclick="showPage('blocks')">Blocks</a>
      <a href="#" onclick="showPage('txs')">Transactions</a>
      <a href="#" onclick="showPage('tokens')">Tokens</a>
      <a href="#" onclick="showPage('contracts')">Contracts</a>
      <a href="#" onclick="showPage('verify')">Verify Contract</a>
    </nav>
    <div class="search-box">
      <input type="text" id="searchInput" placeholder="Search by Address / Txn Hash / Block / Token">
      <button onclick="doSearch()">Search</button>
    </div>
  </div>
</div>

<div class="container">

  <!-- HOME PAGE -->
  <div id="page-home" class="page active">
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">WTX PRICE</div>
        <div class="stat-value">$0.00</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">BLOCKS</div>
        <div class="stat-value blue" id="stat-blocks">--</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">TRANSACTIONS</div>
        <div class="stat-value" id="stat-txs">--</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">STAKING</div>
        <div class="stat-value green" id="stat-staking">--</div>
      </div>
    </div>

    <div class="two-col">
      <div class="card">
        <div class="card-header">Latest Blocks</div>
        <div class="card-body">
          <table>
            <thead><tr><th>Block</th><th>Type</th><th>Txns</th><th>Time</th></tr></thead>
            <tbody id="home-blocks"></tbody>
          </table>
        </div>
      </div>
      <div class="card">
        <div class="card-header">Latest Transactions</div>
        <div class="card-body">
          <table>
            <thead><tr><th>Txn Hash</th><th>Block</th><th>Time</th></tr></thead>
            <tbody id="home-txs"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- BLOCKS PAGE -->
  <div id="page-blocks" class="page">
    <div class="card">
      <div class="card-header">Blocks</div>
      <div class="card-body">
        <table>
          <thead><tr><th>Block</th><th>Hash</th><th>Type</th><th>Txns</th><th>Size</th><th>Time</th></tr></thead>
          <tbody id="blocks-table"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- TRANSACTIONS PAGE -->
  <div id="page-txs" class="page">
    <div class="card">
      <div class="card-header">Transactions</div>
      <div class="card-body">
        <table>
          <thead><tr><th>Txn Hash</th><th>Block</th><th>From</th><th>To</th><th>Value</th></tr></thead>
          <tbody id="txs-table"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- TOKENS PAGE -->
  <div id="page-tokens" class="page">
    <div class="card">
      <div class="card-header">Token Tracker (QRC-20)</div>
      <div class="card-body">
        <table>
          <thead><tr><th>Token</th><th>Symbol</th><th>Contract Address</th><th>Total Supply</th><th>Actions</th></tr></thead>
          <tbody id="tokens-table"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- CONTRACTS PAGE -->
  <div id="page-contracts" class="page">
    <div class="card">
      <div class="card-header">
        Smart Contracts
        <button class="btn btn-primary" onclick="showPage('verify')">Verify Contract</button>
      </div>
      <div class="card-body">
        <table>
          <thead><tr><th>Address (Hex)</th><th>Address (Base58)</th><th>Type</th><th>Name</th><th>Actions</th></tr></thead>
          <tbody id="contracts-table"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- CONTRACT VERIFY PAGE -->
  <div id="page-verify" class="page">
    <div class="card">
      <div class="card-header">Verify & Publish Contract Source Code</div>
      <div class="card-body">
        <div class="form-group">
          <label>Contract Address</label>
          <input type="text" id="verify-address" placeholder="0x... or wXXX...">
        </div>
        <div class="form-group">
          <label>Contract Name</label>
          <input type="text" id="verify-name" placeholder="MyContract">
        </div>
        <div class="form-group">
          <label>Compiler Version</label>
          <select id="verify-compiler">
            <option>v0.8.22</option>
            <option>v0.8.20</option>
            <option>v0.8.19</option>
            <option>v0.8.0</option>
          </select>
        </div>
        <div class="form-group">
          <label>Optimization</label>
          <select id="verify-optimization">
            <option value="1">Yes (200 runs)</option>
            <option value="0">No</option>
          </select>
        </div>
        <div class="form-group">
          <label>Solidity Source Code</label>
          <textarea id="verify-source" placeholder="// SPDX-License-Identifier: MIT&#10;pragma solidity ^0.8.0;&#10;&#10;contract MyContract { ... }"></textarea>
        </div>
        <div class="form-group">
          <label>Contract ABI (JSON)</label>
          <textarea id="verify-abi" placeholder='[{"inputs":[],"name":"myFunction","outputs":[{"type":"uint256"}],"stateMutability":"view","type":"function"}]'></textarea>
        </div>
        <div class="form-group">
          <label>Constructor Arguments (hex, optional)</label>
          <input type="text" id="verify-args" placeholder="0x...">
        </div>
        <button class="btn btn-primary" onclick="verifyContract()">Verify and Publish</button>
        <div id="verify-result" style="margin-top: 15px;"></div>
      </div>
    </div>
  </div>

  <!-- BLOCK DETAIL PAGE -->
  <div id="page-block" class="page">
    <div class="card">
      <div class="card-header">Block Details</div>
      <div class="card-body" id="block-details"></div>
    </div>
  </div>

  <!-- TX DETAIL PAGE -->
  <div id="page-tx" class="page">
    <div class="card">
      <div class="card-header">Transaction Details</div>
      <div class="card-body" id="tx-details"></div>
    </div>
  </div>

  <!-- ADDRESS PAGE -->
  <div id="page-address" class="page">
    <div class="card">
      <div class="card-header">Address</div>
      <div class="card-body" id="address-header"></div>
    </div>
    <div class="card">
      <div class="tabs" id="address-tabs"></div>
      <div class="card-body" id="address-content"></div>
    </div>
  </div>

  <!-- TOKEN DETAIL PAGE -->
  <div id="page-token" class="page">
    <div class="card">
      <div class="card-header">Token Details</div>
      <div class="card-body" id="token-details"></div>
    </div>
    <div class="card">
      <div class="card-header">Read Contract</div>
      <div class="card-body" id="token-read"></div>
    </div>
  </div>

  <!-- CONTRACT DETAIL PAGE -->
  <div id="page-contract" class="page">
    <div class="card">
      <div class="card-header">Contract Details</div>
      <div class="card-body" id="contract-header"></div>
    </div>
    <div class="card">
      <div class="tabs">
        <div class="tab active" onclick="showContractTab('code')">Code</div>
        <div class="tab" onclick="showContractTab('read')">Read Contract</div>
        <div class="tab" onclick="showContractTab('write')">Write Contract</div>
        <div class="tab" onclick="showContractTab('events')">Events</div>
      </div>
      <div class="card-body">
        <div id="contract-code" class="tab-content active"></div>
        <div id="contract-read" class="tab-content"></div>
        <div id="contract-write" class="tab-content"></div>
        <div id="contract-events" class="tab-content"></div>
      </div>
    </div>
  </div>

</div>

<script>
const API = 'http://localhost:3001/api';
let currentContract = null;

// Page navigation
function showPage(page) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById('page-' + page).classList.add('active');

  if (page === 'home') loadHome();
  else if (page === 'blocks') loadBlocks();
  else if (page === 'txs') loadTransactions();
  else if (page === 'tokens') loadTokens();
  else if (page === 'contracts') loadContracts();
}

// Load home page
async function loadHome() {
  try {
    const [chain, blocks] = await Promise.all([
      fetch(API + '/chain').then(r => r.json()),
      fetch(API + '/blocks?limit=10').then(r => r.json())
    ]);

    document.getElementById('stat-blocks').textContent = chain.blocks.toLocaleString();
    document.getElementById('stat-staking').textContent = chain.stakingInfo?.staking ? 'Active' : 'Inactive';

    // Blocks table
    document.getElementById('home-blocks').innerHTML = blocks.blocks.slice(0, 8).map(b => `
      <tr>
        <td><a href="#" class="hash" onclick="viewBlock(${b.height})">${b.height}</a></td>
        <td><span class="badge ${b.is_pos ? 'badge-pos' : 'badge-pow'}">${b.is_pos ? 'PoS' : 'PoW'}</span></td>
        <td>${b.tx_count}</td>
        <td>${timeAgo(b.timestamp)}</td>
      </tr>
    `).join('');

    // Recent txs
    let txHtml = '';
    for (const b of blocks.blocks.slice(0, 5)) {
      txHtml += `<tr>
        <td><a href="#" class="hash" onclick="viewBlock(${b.height})">Block ${b.height}</a></td>
        <td>${b.height}</td>
        <td>${timeAgo(b.timestamp)}</td>
      </tr>`;
    }
    document.getElementById('home-txs').innerHTML = txHtml;

  } catch(e) {
    console.error(e);
  }
}

// Load blocks page
async function loadBlocks() {
  try {
    const data = await fetch(API + '/blocks?limit=50').then(r => r.json());
    document.getElementById('blocks-table').innerHTML = data.blocks.map(b => `
      <tr>
        <td><a href="#" class="hash" onclick="viewBlock(${b.height})">${b.height}</a></td>
        <td class="hash">${truncate(b.hash, 16)}</td>
        <td><span class="badge ${b.is_pos ? 'badge-pos' : 'badge-pow'}">${b.is_pos ? 'PoS' : 'PoW'}</span></td>
        <td>${b.tx_count}</td>
        <td>${(b.size/1024).toFixed(2)} KB</td>
        <td>${timeAgo(b.timestamp)}</td>
      </tr>
    `).join('');
  } catch(e) {
    document.getElementById('blocks-table').innerHTML = '<tr><td colspan="6">Error loading blocks</td></tr>';
  }
}

// Load tokens
async function loadTokens() {
  try {
    const data = await fetch(API + '/contracts').then(r => r.json());
    const tokens = data.contracts.filter(c => c.isToken);

    let html = '';
    for (const t of tokens) {
      const tokenInfo = await fetch(API + '/token/' + t.address.replace('0x', '')).then(r => r.json()).catch(() => null);
      html += `
        <tr>
          <td><span class="badge badge-token">${t.token?.name || 'Unknown'}</span></td>
          <td><strong>${t.token?.symbol || '???'}</strong></td>
          <td><a href="#" class="hash" onclick="viewToken('${t.address}')">${truncate(t.address, 16)}</a></td>
          <td>${tokenInfo?.token?.total_supply || '-'}</td>
          <td>
            <button class="btn btn-secondary" onclick="viewToken('${t.address}')">View</button>
          </td>
        </tr>
      `;
    }
    document.getElementById('tokens-table').innerHTML = html || '<tr><td colspan="5">No tokens found</td></tr>';
  } catch(e) {
    document.getElementById('tokens-table').innerHTML = '<tr><td colspan="5">Error loading tokens</td></tr>';
  }
}

// Load contracts
async function loadContracts() {
  try {
    const data = await fetch(API + '/contracts').then(r => r.json());
    document.getElementById('contracts-table').innerHTML = data.contracts.map(c => `
      <tr>
        <td><a href="#" class="hash" onclick="viewContract('${c.address}')">${truncate(c.address, 16)}</a></td>
        <td class="address">${c.base58Address}</td>
        <td><span class="badge ${c.isToken ? 'badge-token' : 'badge-pow'}">${c.isToken ? 'Token' : 'Contract'}</span></td>
        <td>${c.token?.name || '-'}</td>
        <td>
          <button class="btn btn-secondary" onclick="viewContract('${c.address}')">View</button>
        </td>
      </tr>
    `).join('') || '<tr><td colspan="5">No contracts found</td></tr>';
  } catch(e) {
    document.getElementById('contracts-table').innerHTML = '<tr><td colspan="5">Error loading contracts</td></tr>';
  }
}

// View block
async function viewBlock(height) {
  showPage('block');
  document.getElementById('block-details').innerHTML = '<div class="loading">Loading...</div>';

  try {
    const data = await fetch(API + '/block/' + height).then(r => r.json());
    const b = data.block;

    document.getElementById('block-details').innerHTML = `
      <div class="detail-row"><div class="detail-label">Block Height:</div><div class="detail-value">${b.height}</div></div>
      <div class="detail-row"><div class="detail-label">Status:</div><div class="detail-value"><span class="badge badge-success">Confirmed</span></div></div>
      <div class="detail-row"><div class="detail-label">Timestamp:</div><div class="detail-value">${new Date(b.timestamp * 1000).toLocaleString()}</div></div>
      <div class="detail-row"><div class="detail-label">Block Type:</div><div class="detail-value"><span class="badge ${b.is_pos ? 'badge-pos' : 'badge-pow'}">${b.is_pos ? 'Proof of Stake' : 'Proof of Work'}</span></div></div>
      <div class="detail-row"><div class="detail-label">Transactions:</div><div class="detail-value">${b.tx_count} transactions</div></div>
      <div class="detail-row"><div class="detail-label">Size:</div><div class="detail-value">${b.size.toLocaleString()} bytes</div></div>
      <div class="detail-row"><div class="detail-label">Hash:</div><div class="detail-value"><span class="address">${b.hash}</span></div></div>
      <div class="detail-row"><div class="detail-label">Parent Hash:</div><div class="detail-value"><a href="#" class="hash" onclick="viewBlock(${b.height - 1})">${b.parent_hash}</a></div></div>
    `;
  } catch(e) {
    document.getElementById('block-details').innerHTML = '<p>Error loading block</p>';
  }
}

// View token
async function viewToken(address) {
  showPage('token');
  const hexAddr = address.replace('0x', '');

  try {
    const tokenData = await fetch(API + '/token/' + hexAddr).then(r => r.json());
    const t = tokenData.token;

    document.getElementById('token-details').innerHTML = `
      <div class="detail-row"><div class="detail-label">Token Name:</div><div class="detail-value"><strong>${t.name}</strong></div></div>
      <div class="detail-row"><div class="detail-label">Symbol:</div><div class="detail-value"><span class="badge badge-token">${t.symbol}</span></div></div>
      <div class="detail-row"><div class="detail-label">Decimals:</div><div class="detail-value">${t.decimals}</div></div>
      <div class="detail-row"><div class="detail-label">Total Supply:</div><div class="detail-value">${t.total_supply} ${t.symbol}</div></div>
      <div class="detail-row"><div class="detail-label">Contract (Hex):</div><div class="detail-value"><span class="address">0x${t.address}</span></div></div>
      <div class="detail-row"><div class="detail-label">Holders:</div><div class="detail-value">${tokenData.holders || 0}</div></div>
      <div class="detail-row"><div class="detail-label">Transfers:</div><div class="detail-value">${tokenData.transfers || 0}</div></div>
    `;

    // Read functions
    document.getElementById('token-read').innerHTML = `
      <h4>Check Balance</h4>
      <div class="form-group">
        <label>Address (hex or base58)</label>
        <input type="text" id="balance-addr" placeholder="wXXX... or 0x...">
      </div>
      <button class="btn btn-primary" onclick="checkBalance('${hexAddr}')">Check Balance</button>
      <div id="balance-result" style="margin-top: 15px;"></div>
    `;
  } catch(e) {
    document.getElementById('token-details').innerHTML = '<p>Error loading token</p>';
  }
}

// Check balance
async function checkBalance(tokenAddr) {
  const addr = document.getElementById('balance-addr').value;
  const resultDiv = document.getElementById('balance-result');

  try {
    // Convert to hex if needed
    let hexAddr = addr;
    if (addr.startsWith('w') || addr.startsWith('W')) {
      const conv = await fetch(API + '/rpc', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({method: 'gethexaddress', params: [addr]})
      }).then(r => r.json());
      hexAddr = conv.result;
    }
    hexAddr = hexAddr.replace('0x', '');

    // Call balanceOf
    const selector = '70a08231'; // balanceOf(address)
    const data = selector + hexAddr.padStart(64, '0');

    const result = await fetch(API + '/rpc', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({method: 'callcontract', params: [tokenAddr, data]})
    }).then(r => r.json());

    if (result.result?.executionResult?.output) {
      const balance = BigInt('0x' + result.result.executionResult.output);
      resultDiv.innerHTML = `<div class="badge badge-success">Balance: ${(Number(balance) / 1e18).toFixed(4)} tokens</div>`;
    } else {
      resultDiv.innerHTML = '<div class="badge badge-pending">Could not read balance</div>';
    }
  } catch(e) {
    resultDiv.innerHTML = '<div style="color:red;">Error: ' + e.message + '</div>';
  }
}

// View contract
async function viewContract(address) {
  showPage('contract');
  const hexAddr = address.replace('0x', '');
  currentContract = { address: hexAddr };

  try {
    // Get contract info
    const [contracts, codeRes] = await Promise.all([
      fetch(API + '/contracts').then(r => r.json()),
      fetch(API + '/rpc', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({method: 'getcontractcode', params: [hexAddr]})
      }).then(r => r.json())
    ]);

    const contract = contracts.contracts.find(c => c.address.replace('0x','') === hexAddr);

    document.getElementById('contract-header').innerHTML = `
      <div class="detail-row"><div class="detail-label">Contract Address:</div><div class="detail-value"><span class="address">0x${hexAddr}</span></div></div>
      <div class="detail-row"><div class="detail-label">Base58 Address:</div><div class="detail-value"><span class="address">${contract?.base58Address || '-'}</span></div></div>
      <div class="detail-row"><div class="detail-label">Type:</div><div class="detail-value"><span class="badge ${contract?.isToken ? 'badge-token' : 'badge-pow'}">${contract?.isToken ? 'QRC-20 Token' : 'Smart Contract'}</span></div></div>
      ${contract?.token ? `<div class="detail-row"><div class="detail-label">Token:</div><div class="detail-value">${contract.token.name} (${contract.token.symbol})</div></div>` : ''}
    `;

    // Code tab
    const code = codeRes.result || '';
    document.getElementById('contract-code').innerHTML = `
      <h4>Contract Bytecode</h4>
      <p>Size: ${Math.floor(code.length / 2)} bytes</p>
      <div class="code-block">${code}</div>

      <h4 style="margin-top: 20px;">Verify Source Code</h4>
      <p>To interact with read/write functions, <a href="#" onclick="showPage('verify')">verify your contract source code</a>.</p>
    `;

    // Read tab - basic QRC20 functions
    document.getElementById('contract-read').innerHTML = `
      <div class="function-card read-fn">
        <div class="function-header" onclick="this.nextElementSibling.classList.toggle('open')">
          <span>name()</span><span>▼</span>
        </div>
        <div class="function-body">
          <button class="btn btn-primary" onclick="callRead('${hexAddr}', '06fdde03')">Query</button>
          <div id="read-name" style="margin-top: 10px;"></div>
        </div>
      </div>
      <div class="function-card read-fn">
        <div class="function-header" onclick="this.nextElementSibling.classList.toggle('open')">
          <span>symbol()</span><span>▼</span>
        </div>
        <div class="function-body">
          <button class="btn btn-primary" onclick="callRead('${hexAddr}', '95d89b41')">Query</button>
          <div id="read-symbol" style="margin-top: 10px;"></div>
        </div>
      </div>
      <div class="function-card read-fn">
        <div class="function-header" onclick="this.nextElementSibling.classList.toggle('open')">
          <span>totalSupply()</span><span>▼</span>
        </div>
        <div class="function-body">
          <button class="btn btn-primary" onclick="callRead('${hexAddr}', '18160ddd')">Query</button>
          <div id="read-totalSupply" style="margin-top: 10px;"></div>
        </div>
      </div>
      <div class="function-card read-fn">
        <div class="function-header" onclick="this.nextElementSibling.classList.toggle('open')">
          <span>decimals()</span><span>▼</span>
        </div>
        <div class="function-body">
          <button class="btn btn-primary" onclick="callRead('${hexAddr}', '313ce567')">Query</button>
          <div id="read-decimals" style="margin-top: 10px;"></div>
        </div>
      </div>
      <div class="function-card read-fn">
        <div class="function-header" onclick="this.nextElementSibling.classList.toggle('open')">
          <span>balanceOf(address)</span><span>▼</span>
        </div>
        <div class="function-body">
          <div class="form-group">
            <label>Address</label>
            <input type="text" id="balanceOf-addr" placeholder="0x... or wXXX...">
          </div>
          <button class="btn btn-primary" onclick="callBalanceOf('${hexAddr}')">Query</button>
          <div id="read-balanceOf" style="margin-top: 10px;"></div>
        </div>
      </div>
    `;

    // Write tab
    document.getElementById('contract-write').innerHTML = `
      <p>⚠️ Write functions require a wallet connection. Use the WATTx Qt wallet or CLI to send transactions.</p>
      <div class="function-card write-fn">
        <div class="function-header" onclick="this.nextElementSibling.classList.toggle('open')">
          <span>transfer(address, uint256)</span><span>▼</span>
        </div>
        <div class="function-body">
          <div class="form-group">
            <label>To Address</label>
            <input type="text" id="transfer-to" placeholder="0x...">
          </div>
          <div class="form-group">
            <label>Amount (in tokens)</label>
            <input type="text" id="transfer-amount" placeholder="100">
          </div>
          <button class="btn btn-secondary" onclick="encodeTransfer('${hexAddr}')">Generate TX Data</button>
          <div id="write-transfer" style="margin-top: 10px;"></div>
        </div>
      </div>
    `;

    // Events tab
    document.getElementById('contract-events').innerHTML = `<p>Event logs for this contract will appear here.</p>`;

  } catch(e) {
    document.getElementById('contract-header').innerHTML = '<p>Error loading contract: ' + e.message + '</p>';
  }
}

function showContractTab(tab) {
  document.querySelectorAll('#page-contract .tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('#page-contract .tab-content').forEach(t => t.classList.remove('active'));
  event.target.classList.add('active');
  document.getElementById('contract-' + tab).classList.add('active');
}

// Call read function
async function callRead(addr, selector) {
  const resultId = 'read-' + {
    '06fdde03': 'name',
    '95d89b41': 'symbol',
    '18160ddd': 'totalSupply',
    '313ce567': 'decimals'
  }[selector];

  try {
    const result = await fetch(API + '/rpc', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({method: 'callcontract', params: [addr, selector]})
    }).then(r => r.json());

    let output = result.result?.executionResult?.output || '';
    let decoded = '';

    if (selector === '06fdde03' || selector === '95d89b41') {
      // Decode string
      decoded = decodeString(output);
    } else if (selector === '18160ddd') {
      // Decode uint256
      decoded = (Number(BigInt('0x' + output)) / 1e18).toString() + ' tokens';
    } else if (selector === '313ce567') {
      decoded = parseInt(output, 16).toString();
    }

    document.getElementById(resultId).innerHTML = `<code>${decoded || output}</code>`;
  } catch(e) {
    document.getElementById(resultId).innerHTML = `<span style="color:red;">Error</span>`;
  }
}

async function callBalanceOf(addr) {
  const input = document.getElementById('balanceOf-addr').value;
  let hexAddr = input.replace('0x', '');

  if (input.startsWith('w')) {
    const conv = await fetch(API + '/rpc', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({method: 'gethexaddress', params: [input]})
    }).then(r => r.json());
    hexAddr = conv.result;
  }

  const data = '70a08231' + hexAddr.padStart(64, '0');
  const result = await fetch(API + '/rpc', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({method: 'callcontract', params: [addr, data]})
  }).then(r => r.json());

  const output = result.result?.executionResult?.output || '0';
  const balance = Number(BigInt('0x' + output)) / 1e18;
  document.getElementById('read-balanceOf').innerHTML = `<code>${balance} tokens</code>`;
}

// Encode transfer
function encodeTransfer(addr) {
  const to = document.getElementById('transfer-to').value.replace('0x', '').padStart(64, '0');
  const amount = BigInt(parseFloat(document.getElementById('transfer-amount').value) * 1e18).toString(16).padStart(64, '0');
  const data = 'a9059cbb' + to + amount;

  document.getElementById('write-transfer').innerHTML = `
    <p>Use this data with <code>sendtocontract</code>:</p>
    <div class="code-block">wattx-cli sendtocontract ${addr} ${data}</div>
  `;
}

// Verify contract
async function verifyContract() {
  const resultDiv = document.getElementById('verify-result');

  const data = {
    address: document.getElementById('verify-address').value,
    name: document.getElementById('verify-name').value,
    sourceCode: document.getElementById('verify-source').value,
    abi: document.getElementById('verify-abi').value,
    compilerVersion: document.getElementById('verify-compiler').value,
    optimization: document.getElementById('verify-optimization').value === '1'
  };

  try {
    const res = await fetch(API + '/contract/verify', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(data)
    }).then(r => r.json());

    if (res.success) {
      resultDiv.innerHTML = '<div class="badge badge-success">Contract verified successfully!</div>';
    } else {
      resultDiv.innerHTML = '<div class="badge badge-pending">Verification failed: ' + res.error + '</div>';
    }
  } catch(e) {
    resultDiv.innerHTML = '<div style="color:red;">Error: ' + e.message + '</div>';
  }
}

// Search
async function doSearch() {
  const q = document.getElementById('searchInput').value.trim();
  if (!q) return;

  // Block number
  if (/^\d+$/.test(q)) {
    return viewBlock(parseInt(q));
  }

  // Address
  if (q.startsWith('w') || q.startsWith('W') || q.startsWith('0x') || q.length === 40) {
    // Check if token
    try {
      const token = await fetch(API + '/token/' + q.replace('0x', '')).then(r => r.json());
      if (token.token) return viewToken(q);
    } catch(e) {}
    return viewContract(q);
  }

  alert('Could not find: ' + q);
}

document.getElementById('searchInput').addEventListener('keypress', e => {
  if (e.key === 'Enter') doSearch();
});

// Utilities
function truncate(str, len) {
  if (!str) return '';
  return str.length > len ? str.slice(0, len/2) + '...' + str.slice(-len/2) : str;
}

function timeAgo(ts) {
  const diff = Math.floor(Date.now() / 1000) - ts;
  if (diff < 60) return diff + ' secs ago';
  if (diff < 3600) return Math.floor(diff/60) + ' mins ago';
  if (diff < 86400) return Math.floor(diff/3600) + ' hrs ago';
  return Math.floor(diff/86400) + ' days ago';
}

function decodeString(hex) {
  if (!hex || hex.length < 128) return '';
  const len = parseInt(hex.slice(64, 128), 16);
  const strHex = hex.slice(128, 128 + len * 2);
  let str = '';
  for (let i = 0; i < strHex.length; i += 2) {
    str += String.fromCharCode(parseInt(strHex.substr(i, 2), 16));
  }
  return str;
}

// Load transactions
async function loadTransactions() {
  document.getElementById('txs-table').innerHTML = '<tr><td colspan="5">Loading transactions from blocks...</td></tr>';
}

// Initial load
loadHome();
</script>

</body>
</html>
